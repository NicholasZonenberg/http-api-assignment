<!DOCTYPE html>
<html lang="en">
<head>
  <title>Our simple HTTP server</title>
  <link rel="stylesheet" type="text/css" href="/style.css">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ajv/6.6.1/ajv.bundle.js"></script>
  <script type="text/babel">
    var inputData = [];

    var schema = {
      "definitions": {},
      "$schema": "http://json-schema.org/draft-07/schema#",
      "$id": "http://example.com/root.json",
      "type": "object",
      "title": "The Root Schema",
      "required": [
        "profiledata",
        "DaysSleep"
      ],
      "properties": {
        "profiledata": {
          "$id": "#/properties/profiledata",
          "type": "object",
          "title": "The Profiledata Schema",
          "required": [
            "Birthday",
            "Gender",
            "Height",
            "Weight",
            "WorkSleepAmount",
            "WorkToFallAsleepMinutes",
            "WorkWakeHowManyTimes",
            "WorkEachAwakeMinutes",
            "WorkQualityOfSleep",
            "WorkIWakeUpWith",
            "WorkNeedSleep",
            "WorkDipInEnergy",
            "WorkDipTime",
            "WorkUsualBedtime",
            "WorkUsualWakeTime",
            "WorkTimeToWakeUp",
            "WeekendSleepAmount",
            "WeekendToFallAsleepMinutes",
            "WeekendWakeHowManyTimes",
            "WeekendEachAwakeMinutes",
            "WeekendQualityOfSleep",
            "WeekendIWakeUpWith",
            "WeekendNeedSleep",
            "WeekendDipInEnergy",
            "WeekendDipTime",
            "WeekendUsualBedtime",
            "WeekendUsualWakeTime",
            "WeekendTimeToWakeUp",
            "OverallTypeLevelAlertness",
            "OverallTypeLevelMental",
            "OverallTypeLevelPhysical",
            "OverallTypeLevelMood",
            "TypeOfPerson"
          ],
          "properties": {
            "Birthday": {
              "$id": "#/properties/profiledata/properties/Birthday",
              "type": "string",
              "title": "The Birthday Schema",
              "default": "",
              "examples": [
                "1972-06-27T16:00:00Z"
              ],
              "pattern": "^(.*)$"
            },
            "Gender": {
              "$id": "#/properties/profiledata/properties/Gender",
              "type": "string",
              "title": "The Gender Schema",
              "default": "",
              "examples": [
                "Male"
              ],
              "pattern": "^(.*)$"
            },
            "Height": {
              "$id": "#/properties/profiledata/properties/Height",
              "type": "integer",
              "title": "The Height Schema",
              "default": 0,
              "examples": [
                66
              ]
            },
            "Weight": {
              "$id": "#/properties/profiledata/properties/Weight",
              "type": "integer",
              "title": "The Weight Schema",
              "default": 0,
              "examples": [
                164
              ]
            },
            "WorkSleepAmount": {
              "$id": "#/properties/profiledata/properties/WorkSleepAmount",
              "type": "integer",
              "title": "The Worksleepamount Schema",
              "default": 0,
              "examples": [
                480
              ]
            },
            "WorkToFallAsleepMinutes": {
              "$id": "#/properties/profiledata/properties/WorkToFallAsleepMinutes",
              "type": "integer",
              "title": "The Worktofallasleepminutes Schema",
              "default": 0,
              "examples": [
                10
              ]
            },
            "WorkWakeHowManyTimes": {
              "$id": "#/properties/profiledata/properties/WorkWakeHowManyTimes",
              "type": "integer",
              "title": "The Workwakehowmanytimes Schema",
              "default": 0,
              "examples": [
                0
              ]
            },
            "WorkEachAwakeMinutes": {
              "$id": "#/properties/profiledata/properties/WorkEachAwakeMinutes",
              "type": "integer",
              "title": "The Workeachawakeminutes Schema",
              "default": 0,
              "examples": [
                0
              ]
            },
            "WorkQualityOfSleep": {
              "$id": "#/properties/profiledata/properties/WorkQualityOfSleep",
              "type": "string",
              "title": "The Workqualityofsleep Schema",
              "default": "",
              "examples": [
                "Good"
              ],
              "pattern": "^(.*)$"
            },
            "WorkIWakeUpWith": {
              "$id": "#/properties/profiledata/properties/WorkIWakeUpWith",
              "type": "string",
              "title": "The Workiwakeupwith Schema",
              "default": "",
              "examples": [
                "Without"
              ],
              "pattern": "^(.*)$"
            },
            "WorkNeedSleep": {
              "$id": "#/properties/profiledata/properties/WorkNeedSleep",
              "type": "integer",
              "title": "The Workneedsleep Schema",
              "default": 0,
              "examples": [
                420
              ]
            },
            "WorkDipInEnergy": {
              "$id": "#/properties/profiledata/properties/WorkDipInEnergy",
              "type": "string",
              "title": "The Workdipinenergy Schema",
              "default": "",
              "examples": [
                "Yes"
              ],
              "pattern": "^(.*)$"
            },
            "WorkDipTime": {
              "$id": "#/properties/profiledata/properties/WorkDipTime",
              "type": "string",
              "title": "The Workdiptime Schema",
              "default": "",
              "examples": [
                "2:30 PM"
              ],
              "pattern": "^(.*)$"
            },
            "WorkUsualBedtime": {
              "$id": "#/properties/profiledata/properties/WorkUsualBedtime",
              "type": "string",
              "title": "The Workusualbedtime Schema",
              "default": "",
              "examples": [
                "11:00 PM"
              ],
              "pattern": "^(.*)$"
            },
            "WorkUsualWakeTime": {
              "$id": "#/properties/profiledata/properties/WorkUsualWakeTime",
              "type": "string",
              "title": "The Workusualwaketime Schema",
              "default": "",
              "examples": [
                "7:00 AM"
              ],
              "pattern": "^(.*)$"
            },
            "WorkTimeToWakeUp": {
              "$id": "#/properties/profiledata/properties/WorkTimeToWakeUp",
              "type": "integer",
              "title": "The Worktimetowakeup Schema",
              "default": 0,
              "examples": [
                10
              ]
            },
            "WeekendSleepAmount": {
              "$id": "#/properties/profiledata/properties/WeekendSleepAmount",
              "type": "integer",
              "title": "The Weekendsleepamount Schema",
              "default": 0,
              "examples": [
                420
              ]
            },
            "WeekendToFallAsleepMinutes": {
              "$id": "#/properties/profiledata/properties/WeekendToFallAsleepMinutes",
              "type": "integer",
              "title": "The Weekendtofallasleepminutes Schema",
              "default": 0,
              "examples": [
                10
              ]
            },
            "WeekendWakeHowManyTimes": {
              "$id": "#/properties/profiledata/properties/WeekendWakeHowManyTimes",
              "type": "integer",
              "title": "The Weekendwakehowmanytimes Schema",
              "default": 0,
              "examples": [
                0
              ]
            },
            "WeekendEachAwakeMinutes": {
              "$id": "#/properties/profiledata/properties/WeekendEachAwakeMinutes",
              "type": "integer",
              "title": "The Weekendeachawakeminutes Schema",
              "default": 0,
              "examples": [
                0
              ]
            },
            "WeekendQualityOfSleep": {
              "$id": "#/properties/profiledata/properties/WeekendQualityOfSleep",
              "type": "string",
              "title": "The Weekendqualityofsleep Schema",
              "default": "",
              "examples": [
                "Good"
              ],
              "pattern": "^(.*)$"
            },
            "WeekendIWakeUpWith": {
              "$id": "#/properties/profiledata/properties/WeekendIWakeUpWith",
              "type": "string",
              "title": "The Weekendiwakeupwith Schema",
              "default": "",
              "examples": [
                "With"
              ],
              "pattern": "^(.*)$"
            },
            "WeekendNeedSleep": {
              "$id": "#/properties/profiledata/properties/WeekendNeedSleep",
              "type": "integer",
              "title": "The Weekendneedsleep Schema",
              "default": 0,
              "examples": [
                420
              ]
            },
            "WeekendDipInEnergy": {
              "$id": "#/properties/profiledata/properties/WeekendDipInEnergy",
              "type": "string",
              "title": "The Weekenddipinenergy Schema",
              "default": "",
              "examples": [
                "Yes"
              ],
              "pattern": "^(.*)$"
            },
            "WeekendDipTime": {
              "$id": "#/properties/profiledata/properties/WeekendDipTime",
              "type": "string",
              "title": "The Weekenddiptime Schema",
              "default": "",
              "examples": [
                "3:30 PM"
              ],
              "pattern": "^(.*)$"
            },
            "WeekendUsualBedtime": {
              "$id": "#/properties/profiledata/properties/WeekendUsualBedtime",
              "type": "string",
              "title": "The Weekendusualbedtime Schema",
              "default": "",
              "examples": [
                "11:00 PM"
              ],
              "pattern": "^(.*)$"
            },
            "WeekendUsualWakeTime": {
              "$id": "#/properties/profiledata/properties/WeekendUsualWakeTime",
              "type": "string",
              "title": "The Weekendusualwaketime Schema",
              "default": "",
              "examples": [
                "7:00 AM"
              ],
              "pattern": "^(.*)$"
            },
            "WeekendTimeToWakeUp": {
              "$id": "#/properties/profiledata/properties/WeekendTimeToWakeUp",
              "type": "integer",
              "title": "The Weekendtimetowakeup Schema",
              "default": 0,
              "examples": [
                19
              ]
            },
            "OverallTypeLevelAlertness": {
              "$id": "#/properties/profiledata/properties/OverallTypeLevelAlertness",
              "type": "string",
              "title": "The Overalltypelevelalertness Schema",
              "default": "",
              "examples": [
                "High"
              ],
              "pattern": "^(.*)$"
            },
            "OverallTypeLevelMental": {
              "$id": "#/properties/profiledata/properties/OverallTypeLevelMental",
              "type": "string",
              "title": "The Overalltypelevelmental Schema",
              "default": "",
              "examples": [
                "High"
              ],
              "pattern": "^(.*)$"
            },
            "OverallTypeLevelPhysical": {
              "$id": "#/properties/profiledata/properties/OverallTypeLevelPhysical",
              "type": "string",
              "title": "The Overalltypelevelphysical Schema",
              "default": "",
              "examples": [
                "Medium"
              ],
              "pattern": "^(.*)$"
            },
            "OverallTypeLevelMood": {
              "$id": "#/properties/profiledata/properties/OverallTypeLevelMood",
              "type": "string",
              "title": "The Overalltypelevelmood Schema",
              "default": "",
              "examples": [
                "High"
              ],
              "pattern": "^(.*)$"
            },
            "TypeOfPerson": {
              "$id": "#/properties/profiledata/properties/TypeOfPerson",
              "type": "integer",
              "title": "The Typeofperson Schema",
              "default": 0,
              "examples": [
                30
              ]
            }
          }
        },
        "DaysSleep": {
          "$id": "#/properties/DaysSleep",
          "type": "object",
          "title": "The Dayssleep Schema",
          "required": [
            "UID",
            "deviceId",
            "deviceType",
            "sleep_entries"
          ],
          "properties": {
            "UID": {
              "$id": "#/properties/DaysSleep/properties/UID",
              "type": "string",
              "title": "The Uid Schema",
              "default": "",
              "examples": [
                "ec32f960-93fe-11e8-af77-8bd0e3d9a935"
              ],
              "pattern": "^(.*)$"
            },
            "deviceId": {
              "$id": "#/properties/DaysSleep/properties/deviceId",
              "type": "string",
              "title": "The Deviceid Schema",
              "default": "",
              "examples": [
                "6RWWKH"
              ],
              "pattern": "^(.*)$"
            },
            "deviceType": {
              "$id": "#/properties/DaysSleep/properties/deviceType",
              "type": "integer",
              "title": "The Devicetype Schema",
              "default": 0,
              "examples": [
                1
              ]
            },
            "sleep_entries": {
              "$id": "#/properties/DaysSleep/properties/sleep_entries",
              "type": "array",
              "title": "The Sleep_entries Schema",
              "items": {
                "$id": "#/properties/DaysSleep/properties/sleep_entries/items",
                "type": "object",
                "title": "The Items Schema",
                "required": [
                  "sleepEfficiency",
                  "sleepStartTime",
                  "sleepEndTime",
                  "sleepDuration",
                  "sleepEventTotal"
                ],
                "properties": {
                  "sleepEfficiency": {
                    "$id": "#/properties/DaysSleep/properties/sleep_entries/items/properties/sleepEfficiency",
                    "type": "integer",
                    "title": "The Sleepefficiency Schema",
                    "default": 0,
                    "examples": [
                      93
                    ]
                  },
                  "sleepStartTime": {
                    "$id": "#/properties/DaysSleep/properties/sleep_entries/items/properties/sleepStartTime",
                    "type": "string",
                    "title": "The Sleepstarttime Schema",
                    "default": "",
                    "examples": [
                      "2018-05-03T22:50:30.000"
                    ],
                    "pattern": "^(.*)$"
                  },
                  "sleepEndTime": {
                    "$id": "#/properties/DaysSleep/properties/sleep_entries/items/properties/sleepEndTime",
                    "type": "string",
                    "title": "The Sleependtime Schema",
                    "default": "",
                    "examples": [
                      "2018-05-04T07:35:30.000"
                    ],
                    "pattern": "^(.*)$"
                  },
                  "sleepDuration": {
                    "$id": "#/properties/DaysSleep/properties/sleep_entries/items/properties/sleepDuration",
                    "type": "integer",
                    "title": "The Sleepduration Schema",
                    "default": 0,
                    "examples": [
                      490
                    ]
                  },
                  "sleepEventTotal": {
                    "$id": "#/properties/DaysSleep/properties/sleep_entries/items/properties/sleepEventTotal",
                    "type": "integer",
                    "title": "The Sleepeventtotal Schema",
                    "default": 0,
                    "examples": [
                      429
                    ]
                  }
                }
              }
            }
          }
        }
      }
    }

    var ajv = new Ajv();
    var validate = ajv.compile(schema);

    //function to handle our xhr response
    const handleResponse = (xhr) => {
      //grab the content section
      const content = document.querySelector("#content");
      const type = xhr.getResponseHeader('content-type'); 
      
      const obj = JSON.parse(xhr.response);

      ///parse the response text into a JSON object
      if (type === 'application/json'){
        console.log(obj);
      }
      else if(type === 'text/xml'){
        console.log(xhr.responseXML);
      }
      
      //check the xhr status code and handle accordingly
      switch(xhr.status) {
        case 200: //success
          content.innerHTML = `<b>Success</b> <br> <p id='temp'></p>`;
          if (type === 'application/json'){
            document.getElementById('temp').innerHTML=obj.message;
          }
          else if(type === 'text/xml'){
            document.getElementById('temp').innerHTML=xhr.responseXML.querySelector('message').textContent;
          }
          break;
        case 400: //bad request 
          content.innerHTML = `<b>Bad Request</b> <br> <p id='temp'></p>`;
          document.getElementById('temp').innerHTML=obj.message;
          break;
        case 401:
          content.innerHTML = `<b>Unauthorized</b> <br> <p id='temp'></p>`;
          document.getElementById('temp').innerHTML=obj.message;
          break;
        case 403:
          content.innerHTML = `<b>Forbidden</b> <br> <p id='temp'></p>`;
          document.getElementById('temp').innerHTML=obj.message;
          break;
        case 500:
          content.innerHTML = `<b>Internal Error</b> <br> <p id='temp'></p>`;
          document.getElementById('temp').innerHTML=obj.message;
          break;
        case 501:
          content.innerHTML = `<b>Not Implemented</b> <br> <p id='temp'></p>`;
          document.getElementById('temp').innerHTML=obj.message;
          break;
        case 404: //not found (requested resource does not exist)
          content.innerHTML = `<b>Resource Not Found</b> <br> <p id='temp'></p>`;
          document.getElementById('temp').innerHTML=obj.message;
          break;
        default: //default other errors we are not handling in this example
          content.innerHTML = `Error code not implemented by client.`;
          break;
      }
    };
    
    //function to send ajax
    const sendAjax = (url, acceptedType) => {
      //create a new xhr (ajax) request. 
      //Remember that these are ASYNCHRONOUS
      const xhr = new XMLHttpRequest();
      //set the xhr to a GET request to a certain URL
      xhr.open('GET', url);
      //Set the accept headers to the desired response mime type
      //Server does NOT have to support this. It is a gentle request.
      xhr.setRequestHeader ("Accept", acceptedType);

      //When the xhr loads, call handleResponse and pass the xhr object
      xhr.onload = () => handleResponse(xhr);
      
      //send our ajax request to the server
      xhr.send();
    };

    function formatDate (now) {
      var year = "" + now.getFullYear();
      var month = "" + (now.getMonth() + 1); if (month.length == 1) { month = "0" + month; }
      var day = "" + now.getDate(); if (day.length == 1) { day = "0" + day; }
      var hour = "" + now.getHours(); if (hour.length == 1) { hour = "0" + hour; }
      var minute = "" + now.getMinutes(); if (minute.length == 1) { minute = "0" + minute; }
      var second = "" + now.getSeconds(); if (second.length == 1) { second = "0" + second; }
      return year + "-" + month + "-" + day + "T" + hour + ":" + minute + ":" + second + ".000";
    }

    $(document).ready(function() {
    $.ajax({
        type: "GET",
        url: "/data",
        dataType: "text",
        success: function(data) {
          var result = CSVToArray(data,',');
          for(var x = 1; x < result.length; x++)
          {
            if(result[x][4]){  
              var temp = 0;
              var sleepEff = "efficiency";
              temp = result[x][4].indexOf(sleepEff);
              sleepEff = parseInt(result[x][4].substring(temp + 12, temp + 15));
              //console.log(sleepEff);
              var sleepEnd = "endTime";
              temp = result[x][4].indexOf(sleepEnd);
              sleepEnd = result[x][4].substring(temp + 10, temp + 33);
              //console.log(sleepEnd);
              var sleepTotal = "totalMinutesAsleep";
              temp = result[x][4].indexOf(sleepTotal);
              sleepTotal = parseInt(result[x][4].substring(temp + 20, temp + 25));
              //console.log(sleepTotal);
              var bedTotal = "totalTimeInBed";
              temp = result[x][4].indexOf(bedTotal);
              bedTotal = parseInt(result[x][4].substring(temp + 16, temp + 20));
              //console.log(bedTotal);
              var sleepStart = new Date(sleepEnd);
              sleepStart.setMinutes(-bedTotal);
              sleepStart = formatDate(sleepStart);
              //console.log(sleepStart);
              var entry={
                sleepEfficiency: sleepEff,
                sleepStartTime: sleepStart,
                sleepEndTime: sleepEnd,
                sleepDuration: bedTotal,
                sleepEventTotal: sleepTotal,
              }
              inputData.push(entry);
            }
          }
          console.log(inputData);
          $.ajax({
            type: "GET",
            url: "/user",
            dataType: "json",
            success: function(dat) {
              console.log('JSON GET');
              console.log(dat);
              //var finalOut = JSON.parse(dat);
              dat.DaysSleep={
                UID: "ec32f960-93fe-11e8-af77-8bd0e3d9a935",
                deviceId: "6RWWKH",
                deviceType: 1,
                sleep_entries: inputData,
              };
              console.log(JSON.stringify(dat));
              console.log(dat);
              var valid = validate(dat);
              console.log(valid);
            }
          });
        }
     });
    });

    // ref: http://stackoverflow.com/a/1293163/2343
    // This will parse a delimited string into an array of
    // arrays. The default delimiter is the comma, but this
    // can be overriden in the second argument.
    function CSVToArray( strData, strDelimiter ){
      // Check to see if the delimiter is defined. If not,
      // then default to comma.
      strDelimiter = (strDelimiter || ",");
      // Create a regular expression to parse the CSV values.
      var objPattern = new RegExp((
          // Delimiters.
          "(\\" + strDelimiter + "|\\r?\\n|\\r|^)" +
          // Quoted fields.
          "(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|" +

          // Standard fields.
          "([^\"\\" + strDelimiter + "\\r\\n]*))"
        ),
      "gi"
      );
      // Create an array to hold our data. Give the array
      // a default empty first row.
      var arrData = [[]];
      // Create an array to hold our individual pattern
      // matching groups.
      var arrMatches = null;
      // Keep looping over the regular expression matches
      // until we can no longer find a match.
      while (arrMatches = objPattern.exec( strData )){
        // Get the delimiter that was found.
        var strMatchedDelimiter = arrMatches[ 1 ];
        // Check to see if the given delimiter has a length
        // (is not the start of string) and if it matches
        // field delimiter. If id does not, then we know
        // that this delimiter is a row delimiter.
        if (
          strMatchedDelimiter.length &&
          strMatchedDelimiter !== strDelimiter
          ){
          // Since we have reached a new row of data,
          // add an empty row to our data array.
          arrData.push( [] );
        }
        var strMatchedValue;
        // Now that we have our delimiter out of the way,
        // let's check to see which kind of value we
        // captured (quoted or unquoted).
        if (arrMatches[ 2 ]){
          // We found a quoted value. When we capture
          // this value, unescape any double quotes.
          strMatchedValue = arrMatches[ 2 ].replace(
            new RegExp( "\"\"", "g" ),
            "\""
          );
        } else {
          // We found a non-quoted value.
          strMatchedValue = arrMatches[ 3 ];
        }
        // Now that we have our value string, let's add
        // it to the data array.
        arrData[ arrData.length - 1 ].push( strMatchedValue );
      }
      // Return the parsed data.
      console.log( arrData );
      return( arrData );
    }

    //initialization function
    const init = () => {
      const values = document.querySelector("#page");
      const sendButton = document.querySelector("#send");
      const type = document.querySelector("#type");
      
      //functions to call sendAjax for us with the correct parameters
      const send = () => sendAjax(document.getElementById('page').value, document.getElementById('type').value);
      
      //attach the correct functions to the correct events
      sendButton.addEventListener('click', send);
    };

    window.onload = init;
  </script>
</head>
<body>
  <section id="top">
    <h3>Status Code Tests</h3>
    <select id="page">
      <option value="/success">Success</option>
      <option value="/badRequest">Bad Request</option>
      <option value="/unauthorized">Unauthorized</option>
      <option value="/forbidden">Forbidden</option>
      <option value="/internal">Internal</option>
      <option value="/notImplemented">Not Implemented</option>
      <option value="/notFound">Not Found</option>
    </select>
    <select id="type">
      <option value="application/json">JSON</option>
      <option value="text/xml">XML</option>
    </select>
    <button id="send">Send</button>
  </section>
  <section id="content">
  </section>
</body>
</html>